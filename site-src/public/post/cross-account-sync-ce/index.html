<!DOCTYPE html>
<html lang="en-us">
    
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="theme-color" content="dark">
    <title>Cross account Object Storage bucket sync with Code Engine |  the quest</title>

    
    
    
    <meta property="og:site_name" content="rst quest" />
    <meta property="og:title" content="Cross account Object Storage bucket sync with Code Engine |  the quest"/>
    <meta itemprop="name" content="Cross account Object Storage bucket sync with Code Engine |  the quest" />
    <meta name="twitter:title" content="Cross account Object Storage bucket sync with Code Engine |  the quest" />
    <meta name="application-name" content="Cross account Object Storage bucket sync with Code Engine |  the quest" /><meta name="twitter:card" content="summary"/>

    <meta name="description" content="Using IBM Cloud Code Engine to sync bucket contents from one account to another." />
    <meta name="twitter:description" content="Using IBM Cloud Code Engine to sync bucket contents from one account to another. "/>
    <meta itemprop="description" content=" Using IBM Cloud Code Engine to sync bucket contents from one account to another. "/>
    <meta property="og:description" content=" Using IBM Cloud Code Engine to sync bucket contents from one account to another. " />

    

<meta property="og:type" content="article" />
<meta property="article:publisher" content="Ryan Tiffany" />
<meta property="og:article:published_time" content=2021-03-05T00:00:00Z />
<meta property="article:published_time" content=2021-03-05T00:00:00Z />


  <meta property="og:article:author" content="Ryan tiffany" />
  <meta property="article:author" content="Ryan tiffany" />
  <meta name="author" content="Ryan tiffany" />




<script defer type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "Article",
    "headline": "Cross account Object Storage bucket sync with Code Engine",
    "author": {
      "@type": "Person",
      "name": "Ryan Tiffany"
    },
    "datePublished": "2021-03-05",
    "description": "Using IBM Cloud Code Engine to sync bucket contents from one account to another.",
    "wordCount":  1287 ,
    "mainEntityOfPage": "True",
    "dateModified": "2021-03-05",
    "publisher": {
      "@type": "Organization",
      "name": "Ryan Tiffany",
      "logo": {
        "@type": "imageObject",
        "url": "https:\/\/rst.quest\/favicon.ico"
      }
    }
  }
</script>



    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    
    <link rel="stylesheet" href="/sass/main.min.ab99ff095f832511e24ffb2fba2b51ad473b2f7e9301d674eba2c6c3a6e8bd81.css">
    
</head>
    
    <script>
        (function() {
            const colorSchemeKey = 'ThemeColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'ThemeColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.userColorScheme = 'dark';
        } else {
            document.documentElement.dataset.userColorScheme = 'light';
        }
    })();
</script>


    <body class="dark">
        <nav class="navbar">
    <div class="container">
        <div class="flex">
            <div>
                <a class="brand" href="/">
                    
                    
                        <img src="/favicon.ico" />
                    
                     the quest
                    </a>
            </div>
            <div class="flex">
                
                <a href="/articles/">Articles</a>
                
                <a href="/tags/">Tags</a>
                
                
                    <button id="dark-mode-button">
                    <svg class="light" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" focusable="false" width="1em" height="1em" style="-ms-transform: rotate(360deg); -webkit-transform: rotate(360deg); transform: rotate(360deg);" preserveAspectRatio="xMidYMid meet" viewBox="0 0 36 36"><path fill="#FFD983" d="M30.312.776C32 19 20 32 .776 30.312c8.199 7.717 21.091 7.588 29.107-.429C37.9 21.867 38.03 8.975 30.312.776z"/><path d="M30.705 15.915a1.163 1.163 0 1 0 1.643 1.641a1.163 1.163 0 0 0-1.643-1.641zm-16.022 14.38a1.74 1.74 0 0 0 0 2.465a1.742 1.742 0 1 0 0-2.465zm13.968-2.147a2.904 2.904 0 0 1-4.108 0a2.902 2.902 0 0 1 0-4.107a2.902 2.902 0 0 1 4.108 0a2.902 2.902 0 0 1 0 4.107z" fill="#FFCC4D"/><rect x="0" y="0" width="36" height="36" fill="rgba(0, 0, 0, 0)" /></svg>
                    <svg class="dark" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" focusable="false" width="1em" height="1em" style="-ms-transform: rotate(360deg); -webkit-transform: rotate(360deg); transform: rotate(360deg);" preserveAspectRatio="xMidYMid meet" viewBox="0 0 36 36"><path fill="#FFD983" d="M16 2s0-2 2-2s2 2 2 2v2s0 2-2 2s-2-2-2-2V2zm18 14s2 0 2 2s-2 2-2 2h-2s-2 0-2-2s2-2 2-2h2zM4 16s2 0 2 2s-2 2-2 2H2s-2 0-2-2s2-2 2-2h2zm5.121-8.707s1.414 1.414 0 2.828s-2.828 0-2.828 0L4.878 8.708s-1.414-1.414 0-2.829c1.415-1.414 2.829 0 2.829 0l1.414 1.414zm21 21s1.414 1.414 0 2.828s-2.828 0-2.828 0l-1.414-1.414s-1.414-1.414 0-2.828s2.828 0 2.828 0l1.414 1.414zm-.413-18.172s-1.414 1.414-2.828 0s0-2.828 0-2.828l1.414-1.414s1.414-1.414 2.828 0s0 2.828 0 2.828l-1.414 1.414zm-21 21s-1.414 1.414-2.828 0s0-2.828 0-2.828l1.414-1.414s1.414-1.414 2.828 0s0 2.828 0 2.828l-1.414 1.414zM16 32s0-2 2-2s2 2 2 2v2s0 2-2 2s-2-2-2-2v-2z"/><circle fill="#FFD983" cx="18" cy="18" r="10"/><rect x="0" y="0" width="36" height="36" fill="rgba(0, 0, 0, 0)" /></svg>
                    </button>
                
            </div>
            </div>
    </div>
</nav>

        <main>
            
<div class="container">
    <article>
        <header class="article-header">
            <div class="thumb">
                <div>
                    <h1>Cross account Object Storage bucket sync with Code Engine</h1>
                    <div class="post-meta">
                        <div>
                            
                            
                            By Ryan Tiffany | <time>March 05, 2021</time>
                            | 7 minutes
                        </div>
                        <div class="tags">
                            
                            <a href="/tags/code-engine/">code-engine</a>
                            
                            <a href="/tags/serverless/">serverless</a>
                            
                            <a href="/tags/object-storage/">object-storage</a>
                            
                        </div>
                    </div>
                </div>
            </div>
        </header>
    </article>

    <div class="article-post">
    <h2 id="overview">
    <a href="#overview" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    Overview
</h2>
<p>In this guide I will show you how to sync <a href="https://cloud.ibm.com/docs/cloud-object-storage?topic=cloud-object-storage-about-cloud-object-storage">IBM Cloud Object Storage</a> buckets between accounts using <a href="https://cloud.ibm.com/docs/codeengine">Code Engine</a>. Code Engine provides a platform to unify the deployment of all of your container-based applications on a Kubernetes-based infrastructure. The Code Engine experience is designed so that you can focus on writing code without the need for you to learn, or even know about, Kubernetes.</p>
<h2 id="preparing-accounts">
    <a href="#preparing-accounts" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    Preparing Accounts
</h2>
<p>We will be using <a href="https://cloud.ibm.com/docs/cloud-shell?topic=cloud-shell-shell-ui">Cloud Shell</a> to generate Service IDs and Object Storage credentials for both the source and destination accounts.</p>
<p>We will also be creating a <a href="https://cloud.ibm.com/docs/account?topic=account-serviceids">Service ID</a> on the both accounts. A service ID identifies a service or application similar to how a user ID identifies a user. We can assign specific access policies to the service ID that restrict permissions for using specific services: in this case it gets <em>read-only</em> access to an Object Storage bucket on the Source Account and <em>write</em> access an Object Storage bucket on the Destination Account.</p>
<h3 id="source-account">
    <a href="#source-account" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    Source Account
</h3>
<p>Launch a Cloud Shell session on the Source Account to begin generating our Object Storage access credentials.</p>
<h4 id="create-service-id">
    <a href="#create-service-id" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    Create Service ID
</h4>
<p>Create a new service ID for the source account.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">ibmcloud iam service-id-create SERVICE_ID_NAME --description <span class="s2">&#34;Service ID for read-only access to bucket&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="create-reader-access-policy-for-newly-created-service-id">
    <a href="#create-reader-access-policy-for-newly-created-service-id" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    Create Reader access policy for newly created Service ID
</h4>
<p>Now we will limit the scope of this service ID to have read only access to our source Object Storage bucket.</p>
<ul>
<li><code>SERVICE_ID</code>: The ID of the Service ID created in the previous step.</li>
<li><code>ICOS_SERVICE_INSTANCE_ID</code>: The GUID of the Cloud Object Storage instance on the source account. You can retrieve this with the command: <code>ibmcloud resource service-instance &lt;name of icos instance&gt;</code></li>
<li><code>SOURCE_BUCKET_NAME</code>: The name of the source account bucket that we will sync with the destination bucket.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">ibmcloud iam service-policy-create SERVICE_ID --roles Reader <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--service-name cloud-object-storage --service-instance ICOS_SERVICE_INSTANCE_ID <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--resource-type bucket --resource SOURCE_BUCKET_NAME
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="generate-hmac-credentials-tied-to-our-service-id">
    <a href="#generate-hmac-credentials-tied-to-our-service-id" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    Generate HMAC credentials tied to our service ID
</h4>
<p>In order for the Minio client to talk to each Object Storage instance it will need HMAC credentials (Access Key and Secret Key in S3 parlance).</p>
<ul>
<li><code>SERVICE_ID</code>: The ID of the Service ID created in the previous step.</li>
<li><code>ICOS_SERVICE_INSTANCE_ID</code>: The GUID of the Cloud Object Storage instance on the source account.</li>
<li><code>SERVICE_ID_KEY_NAME</code>: The name of the Service ID credentials to create.</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ ibmcloud resource service-key-create SERVICE_ID_KEY_NAME Reader --instance-id ICOS_SERVICE_INSTANCE_ID <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--service-id SERVICE_ID --parameters <span class="s1">&#39;{&#34;HMAC&#34;:true}&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><em>Important Outputs:</em>
Take note of the output from the Serice Key output. These values will be used when creating our Code Engine Job.</p>
<ul>
<li><code>access_key_id</code> will be used as the variable <code>SOURCE_ACCESS_KEY</code></li>
<li><code>secret_access_key</code> will be used as the variable <code>SOURCE_SECRET_KEY</code></li>
</ul>
<hr>
<h3 id="destination-account">
    <a href="#destination-account" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    Destination Account
</h3>
<p>Launch a Cloud Shell session on the Source Account to begin generating our Object Storage access credentials.</p>
<p><strong>Create Service ID</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ ibmcloud iam service-id-create SERVICE_ID_NAME --description <span class="s2">&#34;Service ID for write access to destination account bucket&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><em>Inputs:</em></p>
<blockquote>
<ul>
<li><code>SERVICE_ID_NAME</code>: The name for the Service ID on the source account.</li>
</ul>
</blockquote>
<p>**Create Reader access policy for newly created service ID: **</p>
<p>Now we will add a Writer policy to our destination bucket bound to the Service ID.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ ibmcloud iam service-policy-create SERVICE_ID --roles Writer --service-name cloud-object-storage <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--service-instance ICOS_SERVICE_INSTANCE_ID --resource-type bucket --resource DESTINATION_BUCKET_NAME
</span></span></code></pre></td></tr></table>
</div>
</div><p><em>Inputs:</em></p>
<blockquote>
<ul>
<li><code>SERVICE_ID</code>: The ID of the Service ID created in the previous step.</li>
<li><code>ICOS_SERVICE_INSTANCE_ID</code>: The GUID of the Cloud Object Storage instance on the source account. You can retrieve this with the command: <code>ibmcloud resource service-instance &lt;name of icos instance&gt;</code></li>
<li><code>DESTINATION_BUCKET_NAME</code>: The name of the source account bucket that we will sync with the destination bucket.</li>
</ul>
</blockquote>
<p><strong>Generate HMAC credentials tied to our service ID:</strong></p>
<p>We&rsquo;ll follow the same procedure as last time to generate the HMAC credentials, but this time on the destination account.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ ibmcloud resource service-key-create SERVICE_ID_KEY_NAME Reader --instance-id ICOS_SERVICE_INSTANCE_ID <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>--service-id SERVICE_ID --parameters <span class="s1">&#39;{&#34;HMAC&#34;:true}&#39;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><em>Inputs:</em></p>
<blockquote>
<ul>
<li><code>SERVICE_ID</code>: The ID of the Service ID created in the previous step.</li>
<li><code>ICOS_SERVICE_INSTANCE_ID</code>: The GUID of the Cloud Object Storage instance on the source account.</li>
<li><code>SERVICE_ID_KEY_NAME</code>:</li>
</ul>
</blockquote>
<p><em>Important Outputs:</em>
Take note of the output from the Serice Key output. These values will be used when creating our Code Engine Job.</p>
<blockquote>
<ul>
<li><code>access_key_id</code> will be used as the variable <code>DESTINATION_ACCESS_KEY</code></li>
<li><code>secret_access_key</code> will be used as the variable <code>DESTINATION_SECRET_KEY</code></li>
</ul>
</blockquote>
<hr>
<h2 id="create-code-engine-project">
    <a href="#create-code-engine-project" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    Create Code Engine Project
</h2>
<p><strong>Target Resource Group:</strong></p>
<p>On the account where you will deploy and run the Code Engine job to sync the buckets jump back in to Cloud Shell. In order to create our Code Engine project we need to make sure that our cloud shell session is targeting the correct resource group.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ ibmcloud target -g RESOURCE_GROUP
</span></span></code></pre></td></tr></table>
</div>
</div><p><em>Inputs:</em></p>
<blockquote>
<ul>
<li><code>RESOURCE_GROUP</code>: Name of the Resource Group to assign to Code Engine Project.</li>
</ul>
</blockquote>
<p><strong>Create Code Engine Project:</strong>
With the correct Resource Group set, we can now create our Code Engine project. We add the <code>--target</code> flag to ensure that future Code Engine commands are targeting the correct project.</p>
<pre tabindex="0"><code>$ ibmcloud ce project create -n PROJECT_NAME --target
</code></pre><p><em>Inputs:</em></p>
<blockquote>
<ul>
<li><code>PROJECT_NAME</code>: Name of the Code Engine Project.</li>
</ul>
</blockquote>
<h3 id="optional-create-docker-container-via-code-engine">
    <a href="#optional-create-docker-container-via-code-engine" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    (Optional) Create Docker container via Code Engine
</h3>
<p>The default image used to sync the buckets is <code>greyhoundforty/mcsync:latest</code>. If you would like to build the container yourself and stick it in to IBM Cloud Container Registry fork this <a href="https://github.com/cloud-design-dev/code-engine-minio-sync">repository</a>, update the Dockerfile if needed, and then use Code Engine to build the image as outlined below.</p>
<p><strong>Create Code Engine Repository Secret:</strong></p>
<p>In order to push our container image in to IBM Cloud Container Registry we need to first set up a Code Engine <a href="https://cloud.ibm.com/docs/codeengine?topic=codeengine-add-registry#add-registry-access-ce">registry secret</a>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">  ibmcloud ce registry create --name REGISTRY_SECRET_NAME --username iamapikey <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --password IBMCLOUD_API_KEY --email YOUR_IBM_ACCOUNT_EMAIL --server ICR_ENDPOINT 
</span></span></code></pre></td></tr></table>
</div>
</div><p>Inputs:</p>
<blockquote>
<ul>
<li><code>REGISTRY_SECRET_NAME</code>: The name of the Code Engine Registry Secret.</li>
<li><code>IBMCLOUD_API_KEY</code>: The IBM Cloud API Key for your account.</li>
<li><code>YOUR_IBM_ACCOUNT_EMAIL</code>: The email associated with your IBM Account.</li>
<li><code>ICR_ENDPOINT</code>: The IBM Container Registry Endpoint to use. See <a href="https://cloud.ibm.com/docs/Registry?topic=Registry-registry_overview#registry_regions">full list</a></li>
</ul>
</blockquote>
<p><strong>Create Container Build:</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">  ic ce build create --name BUILD_NAME --image us.icr.io/NAMESPACE/CONTAINER_NAME:1 --source FORKED_REPO_URL <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --rs REGISTRY_SECRET_NAME --size small 
</span></span></code></pre></td></tr></table>
</div>
</div><p>Inputs:</p>
<blockquote>
<ul>
<li><code>BUILD_NAME</code>: The name of the build job.</li>
<li><code>NAMESPACE</code>: The IBM Container Registry Namespace where the image will be stored. See <a href="">this guide</a> if you need to create a namespace.</li>
<li><code>CONTAINER_NAME</code>: The name of the container.</li>
<li><code>FORKED_REPO_URL</code>: The Github URL for the forked version of the sync container.</li>
<li><code>REGISTRY_SECRET_NAME:</code> The name of the Container Registry Secreate created in the previous step.</li>
</ul>
</blockquote>
<p><strong>Run container build:</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">ibmcloud ce buildrun submit --build BUILD_NAME
</span></span></code></pre></td></tr></table>
</div>
</div><p>Inputs:</p>
<blockquote>
<ul>
<li><code>BUILD_NAME</code>: The name of the build job created in the previous step.</li>
</ul>
</blockquote>
<hr>
<h2 id="deploy-sync-environment">
    <a href="#deploy-sync-environment" class="anchor">
        <svg class="icon" aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16">
            <path fill-rule="evenodd"
                d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z">
            </path>
        </svg>
    </a>
    Deploy Sync Environment
</h2>
<p><strong>Clone this repository:</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">git clone https://github.com/cloud-design-dev/code-engine-minio-sync.git
</span></span><span class="line"><span class="cl"><span class="nb">cd</span> code-engine-minio-sync
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Copy <code>variables.example</code> to <code>.env</code>:</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">  cp variables.example .env 
</span></span></code></pre></td></tr></table>
</div>
</div><p>**Edit <code>.env</code> to match your environment: **</p>
<p>See <a href="#inputs">inputs</a> for available options.</p>
<p><strong>Once updated source the file for use in our session:</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="nb">source</span> .env
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Create Code Engine Secret:</strong></p>
<pre tabindex="0"><code>ibmcloud ce secret create --name CODE_ENGINE_SECRET --from-literal SOURCE_ACCESS_KEY=&#34;${SOURCE_ACCESS_KEY}&#34; \
--from-literal SOURCE_SECRET_KEY=&#34;${SOURCE_SECRET_KEY}&#34; --from-literal SOURCE_REGION=&#34;${SOURCE_REGION}&#34; \
--from-literal SOURCE_BUCKET=&#34;${SOURCE_BUCKET}&#34; --from-literal DESTINATION_REGION=&#34;${DESTINATION_REGION}&#34; \
--from-literal DESTINATION_ACCESS_KEY=&#34;${DESTINATION_ACCESS_KEY}&#34; --from-literal DESTINATION_SECRET_KEY=&#34;${DESTINATION_SECRET_KEY}&#34; \
--from-literal DESTINATION_BUCKET=&#34;${DESTINATION_BUCKET}&#34;
</code></pre><p><em>Inputs:</em></p>
<blockquote>
<ul>
<li><code>CODE_ENGINE_SECRET</code>: Name of the Code Engine Secret. All other variables are picked up from our <code>.env</code> file.</li>
</ul>
</blockquote>
<p><strong>Create Code Engine Job:</strong></p>
<p>If you created your own version of the container image as outlined above you will need to update the command and replace <code>greyhoundforty/mcsync:latest</code> with your image.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">ibmcloud ce job create --name JOB_NAME --image greyhoundforty/mcsync:latest --env-from-secret CODE_ENGINE_SECRET
</span></span></code></pre></td></tr></table>
</div>
</div><p><em>Inputs:</em></p>
<blockquote>
<ul>
<li><code>JOB_NAME</code>: The name of the Code Engine job.</li>
<li><code>CODE_ENGINE_SECRET</code>: Name of the Code Engine Secret. All other variables are picked up from our <code>.env</code> file.</li>
</ul>
</blockquote>
<p><strong>Submit Code Engine Job:</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">ibmcloud ce jobrun submit --job JOB_NAME
</span></span></code></pre></td></tr></table>
</div>
</div><p><em>Inputs:</em></p>
<blockquote>
<ul>
<li><code>JOB_NAME</code>: The name of the Code Engine job.</li>
</ul>
</blockquote>
<p><strong>Check the status of the job:</strong></p>
<p>Depending on the size and number of objects that you are syncing the job could take a bit of time. You can check on the status of the job run by issuing the command:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">ibmcloud ce jobrun get --name JOB_NAME
</span></span></code></pre></td></tr></table>
</div>
</div>
    </div>
</div>

<div class="container">
    
    <nav class="flex container suggested">
        
        <a rel="prev" href="/post/cloud-shell/" title="Previous post (older)">
            <span>Previous</span>
            Getting started with IBM Cloud Shell
            </a>
        
        
        
        <a rel="next" href="/post/container-image-build-ce/" title="Next post (newer)">
            <span>Next</span>
            Container image builds using IBM Code Engine
            </a> 
        
    </nav>
    
</div>
 
<div class="container">
    
</div>

</main>


        </main>
        <footer class="footer flex">
    <section class="container">
        <nav class="footer-links">
            
            <a href="/index.xml">RSS</a>
            
        </nav>

        
    </section>
    <script defer src="/ts/features.b100c41612d4f227737330068fff680507df0ae869dc2d689c8fae0a7f95c711.js" 
    data-enable-footnotes="true"
    ></script>
</footer>

    </body>
</html>